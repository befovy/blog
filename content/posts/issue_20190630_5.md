---
title: ç”¨ CMake ä¸º ijkplayer å¢åŠ  android native debug æ”¯æŒ
date: 2019-06-30 15:26:52 +0000 UTC
lastmod: 2019-12-09 01:43:36 +0000 UTC
---
ç»™ ijkplayer å¢åŠ äº† cmake æ„å»ºæ–¹å¼ï¼Œæ”¯æŒåœ¨ android studio ä¸­è¿›è¡Œ c ä»£ç æ–­ç‚¹è°ƒè¯•ã€‚  
ç›´æ¥ä¸Šæ‰‹è¯·å‰å¾€ https://github.com/befovy/ijkplayer#build-android-via-cmake

å¦‚æœæƒ³äº†è§£ä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹è¯·ç»§ç»­é˜…è¯»æœ¬æ–‡ã€‚

<!--mirror-->

## ijkplayer ç®€ä»‹

[ijkplayer](https://github.com/Bilibili/ijkplayer)  æ˜¯ç”± B ç«™å¼€æºçš„ä¸€æ¬¾ç§»åŠ¨ç«¯æ’­æ”¾å™¨ã€‚åŸºäº ffmpeg ä¸­ ffplay å¼€å‘ï¼Œå¹¶æ·»åŠ  android MediaCodecã€iOS VideotTolbox è§†é¢‘ç¡¬è§£ç æ”¯æŒä»¥åŠ openglesã€NativeWindow(android) æ¸²æŸ“ï¼Œåœ¨å½“å‰çš„ç§»åŠ¨ç›´æ’­çƒ­æ½®ä¸­ï¼Œè¢«å¤§é‡ä½¿ç”¨ã€‚
ä½†ä½¿ç”¨ ijkplayer è¿›è¡Œ android æ’­æ”¾å™¨å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œè°ƒè¯•èµ·æ¥ç¨å¾®æœ‰äº›éº»çƒ¦ï¼Œå®˜æ–¹æä¾›äº†ndk è°ƒè¯•çš„å‡ ä¸ªpatch æ–‡ä»¶ï¼Œå¹¶ä¸”æœ‰ä¸€æ®µæè¿°ï¼Œæ˜¯åŸºäº ndk-build android.mk å·¥å…·é“¾æ„å»ºçš„ã€‚è¯´å®è¯ç”±äºæ²¡æœ‰åšæˆå¼€ç®±å³ç”¨ï¼Œæˆ‘ä¹Ÿæ²¡è®¤çœŸçœ‹è¿‡è¿™éƒ¨åˆ†å†…å®¹ã€‚ ç”±äºæˆ‘å¯¹ cmake çš„äº†è§£æ›´å¤šä¸€äº›ï¼ŒåŠ ä¹‹ google å®˜æ–¹ä¹Ÿé€æ¸å°† ndk çš„å·¥å…·é“¾ç”± ndk-build è½¬å‘ cmakeï¼Œå¹¶åœ¨ android studio ä¸­å¯¹ cmake æä¾›äº†æ›´å¥½çš„æ”¯æŒã€‚åŒæ—¶ cmake ä¹Ÿæ˜¯è·¨å¹³å°çš„æ„å»ºå·¥å…·ï¼Œæ–¹ä¾¿åç»­å°† ijkplayer æ‰©å±•è‡³å…¶å®ƒå¹³å°ï¼Œæ‰€ä»¥æˆ‘ç”¨ cmake é‡æ–°å®ç°äº† ijkplayer çš„æ„å»ºè¿‡ç¨‹ã€‚ 

åªè¦ä¸æ˜¯ä¿®æ”¹ ffmpeg çš„æºä»£ç ï¼Œå…¶å®ƒå†…å®¹åŒ…æ‹¬ ijkplayer çš„ c ä»£ç ä¿®æ”¹ï¼Œ java å±‚ä¿®æ”¹ï¼Œéƒ½å¯ä»¥åœ¨ android studio ä¸­ä¸€é”®è¿è¡Œã€è°ƒè¯•ã€‚

å…³äº ijkplayer å†…éƒ¨æ ¸å¿ƒä»£ç çš„åˆ†æï¼Œå¤šä¸ªçº¿ç¨‹çš„å·¥ä½œå†…å®¹ï¼Œè§£ç éƒ¨åˆ†ï¼ŒéŸ³è§†é¢‘åŒæ­¥æ§åˆ¶ç­‰éƒ¨åˆ†çš„æ›´æ·±å…¥çš„ä»‹ç»ï¼Œå¯ä»¥å‚è€ƒé‡‘å±±äº‘è§†é¢‘çš„åˆ†ææ–‡ç«   https://www.jianshu.com/p/daf0a61cc1e0 ï¼Œ æˆ‘æœ€å¼€å§‹ä¹Ÿæ˜¯ä»è¿™ä¸€ç¯‡æ–‡ç« å…¥æ‰‹é€æ¸è¯»æ‡‚ ijkplayer æºä»£ç çš„ã€‚

é¢˜å¤–è¯ï¼šijkplayer åœ¨ github ä¸Šçš„æäº¤è®°å½•è‡ª k0.8.8 ç‰ˆæœ¬ä¹‹åå°±å†ä¹Ÿæ²¡æœ‰äº†ï¼Œå¥½å¤šäººè¯„è®ºè¯´é¡¹ç›®å·²ç»æ”¾å¼ƒç»´æŠ¤äº†ï¼Œä½†æ˜¯ç»†å¿ƒå¯»æ‰¾ä¼šå‘ç°åœ¨å¦ä¸€ä¸ªé¡¹ç›® [Bilibili/ffmpeg](https://github.com/bilibili/FFmpeg/releases) ä¸­ï¼Œè¿˜ä¸æ–­æœ‰æäº¤è®°å½•ã€‚è¯´æ˜é¡¹ç›®è¿˜æ˜¯åœ¨ä¸æ–­å¼€å‘ï¼Œåªæ˜¯é‡å¿ƒæ”¾åœ¨å®ç°æ–°çš„ ffmpeg protocol ä¸Šï¼Œæ²¡æœ‰åŠæ—¶ç»´æŠ¤ ijkplayer é¡¹ç›®ä¸Šçš„ issuesã€‚

ä¸‹é¢å…·ä½“è¯´è¯´ä¸€äº›å…·ä½“çš„ä¿®æ”¹å†…å®¹ã€‚

<!--mirror-->
## android å·¥ç¨‹ç»“æ„è°ƒæ•´

ijkplayer çš„é¡¹ç›®æœ¬èº«å…·æœ‰å¤šä¸ª android moduleã€‚

```
ijkplayer-arm64
ijkplayer-armv5
ijkplayer-armv7a
ijkplayer-x86
ijkplayer-x86_64   # ä¸Šé¢å‡ ä¸ªéƒ½æ˜¯ä¸€ä¸ªmodule å£³ï¼Œshell å‘½ä»¤ç¼–è¯‘å¥½ so åº“æ”¾åœ¨æŒ‡å®šç›®å½•ä¸­
ijkplayer-example  # ç¤ºä¾‹APPé¡¹ç›®
ijkplayer-exo      # å¯¹ google exoplayer çš„ä¸€å±‚å°è£…é€‚ï¼Œé…åˆijkplayer å®šä¹‰çš„ mediaplyer æ¥å£
ijkplayer-java     # ijkplayer java å±‚ä»£ç ï¼Œå¯¹æ¥ native å±‚ä»£ç ï¼Œä»¥åŠç¡¬è§£ç å™¨çš„é€‰æ‹©
```

é¡¹ç›®ä¸­ä¸ºä¸åŒçš„ cpu æ¶æ„éƒ½å•ç‹¬è®¾ç½®äº† moduleï¼Œè¿™å‡ ä¸ª module æœ€å¤§çš„åŒºåˆ«å°±æ˜¯åœ¨ Application.mk ä¸­ `APP_ABI` å’Œ `APP_PLATFORM` çš„å€¼ä¸åŒï¼Œå…¶ä¸­  `APP_PLATFORM` å–å€¼å’Œ build.gradle ä¸­å®šä¹‰çš„ minSdkVersion ç›¸åŒã€‚
ijkplayer æœ€ä½ç«Ÿç„¶æ”¯æŒ sdk version 9ï¼Œç¡®å®æ„Ÿè°¢ B ç«™é¡¹ç›®ç»„åˆæœŸåœ¨è¿™æ–¹é¢çš„è¾›è‹¦ä»˜å‡ºã€‚

è¿™ç§ module ç¡®å®æ–¹ä¾¿é‡‡ç”¨ ndk-build å·¥å…·çš„é¡¹ç›®ç®¡ç†ï¼Œä½†æ˜¯æˆ‘åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­è¿˜æ˜¯è§‰å¾—æœ‰äº›ä¸å¤ªæ–¹ä¾¿ä¹‹å¤„ï¼š
1. åœ¨ android studio ä¸­æœç´¢ c ä»£ç ï¼Œæœç´¢ç»“æœä¸­é‡å¤å‡ºç°å¤šæ¬¡
2. android studio ä¸­çš„ c ä»£ç æ²¡æœ‰è¯­æ³•é«˜äº®ã€‚ 

å¯¹äºé—®é¢˜1ï¼Œæˆ‘æ‰¾åˆ°çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼š
```
//NOTE:: run `./gradlew ideaModule` to apply exclude dirs
apply plugin: 'idea'

idea.module {
    excludeDirs += file('ijkplayer-armv7a/src/')
    excludeDirs += file('ijkplayer-arm64/src/')
    excludeDirs += file('ijkplayer-armv5/src/')
    excludeDirs += file('ijkplayer-x86/src/')
    excludeDirs += file('ijkplayer-x86_64/src/')
}
```
åœ¨å·¥ç¨‹æ ¹ build.gradle ä¸­å¢åŠ è¿™æ ·çš„é…ç½®ï¼Œå¹¶æ‰§è¡Œ `./gradlew ideaModule`ï¼Œ å°±ä¼šåœ¨æœç´¢ç»“æœä¸­æ’é™¤æ¥è‡ªè¿™å‡ ä¸ªæ–‡ä»¶å¤¹çš„å†…å®¹ã€‚

å¯¹äºé—®é¢˜2ï¼Œæˆ‘å½“ç„¶æ˜¯ç”¨ cmake è§£å†³äº†ï¼Œæ–°å»ºä¸€ä¸ª module, å–å fijkplayer-fullã€‚æ¢ä¸ªåå­—æ–¹ä¾¿å’ŒåŸé¡¹ç›®è¿›è¡ŒåŒºåˆ†ï¼ŒåŒæ—¶ f ä¹Ÿè¡¨ç¤º`full`, æˆ‘åœ¨è¿™ä¸ª module ä¸­å›Šæ‹¬äº†åŸæ¥ 6 ä¸ª module æä¾›çš„å†…å®¹ã€‚ f è¿˜æœ‰åˆ«çš„å«ä¹‰ï¼Œæœ‰æœºä¼šåœ¨å…¶å®ƒåœ°æ–¹ä¼šæåˆ°ã€‚
åœ¨ fijkplayer-full çš„ build.gradel ä¸­å¢åŠ  cmake çš„é…ç½®ä»¥åŠå¼•å…¥ ijkplayer-java module çš„ java æºä»£ç ã€‚
```
android {
    .......
    .......
    sourceSets.main {
        java.srcDirs = ["$rootProject.rootDir/ijkplayer-java/src/main/java/"]
        jni.srcDirs = [] // This prevents the auto generation of Android.mk
    }

    externalNativeBuild {
        cmake {
            path 'src/main/CMakeLists.txt'
        }
    }
}
``` 
ä¿®æ”¹åï¼Œfijkplayer-full å°±æˆäº† "å…­ç¥åˆä½“" äº†ã€‚

å¯¹äºä¸åŒcpu æ¶æ„åŒºåˆ†ä¸åŒçš„ minSdkVersion å¯ä»¥é€šè¿‡ productFlavors å®ç°ï¼Œè¿™ä¸€å—æˆ‘è¿˜æ²¡æœ‰å…·ä½“è€ƒè™‘å……åˆ†ï¼Œç›®å‰æ˜¯ç»Ÿä¸€è®¾ç½®äº†å¤§å®¶ç”¨å¾—æœ€å¤šçš„ minSdkVersion 16ã€‚

æ­¤éƒ¨åˆ†ä¿®æ”¹çš„å®Œæ•´å†…å®¹[ç‚¹æˆ‘æŸ¥çœ‹, github.com/befovy/ijkplayer](https://github.com/befovy/ijkplayer/blob/master/android/ijkplayer/fijkplayer-full/build.gradle)

<!--mirror-->
## CMakeLists.txt
ç¼–å†™ CMakeLists.txt å®Œå…¨æ˜¯ä¸ªç¿»è¯‘å·¥ä½œï¼Œå°† Android.mk ä¸­çš„è§„åˆ™ç¿»è¯‘è¿‡æ¥å°±è¡Œã€‚å®Œæˆåé€šè¿‡ CMake æ–¹å¼æœ€ç»ˆç”Ÿæˆçš„ aar å’ŒåŸå§‹æ–¹å¼ç”Ÿæˆçš„aar æ–‡ä»¶å¤§å°å‡ ä¹æ²¡ä»€ä¹ˆå·®åˆ«ï¼Œè§ä¸‹å›¾ã€‚
fijkplayer-full åªç¼–è¯‘äº† armv7a æ¶æ„ï¼Œå’Œ ijkplayer-armv7a æ¨¡å—ç¼–è¯‘ç»“æœçš„å¯¹æ¯”ã€‚
fijkplayer-full ä¸­ classes.jar è¾ƒå¤§æ˜¯å› ä¸ºåŒ…å«äº† ijkplayer-java module ä¸­çš„å†…å®¹ã€‚
è¿˜å¯ä»¥è°ƒæ•´CMake å‚æ•°è¿›ä¸€æ­¥å‡å°ç”Ÿæˆåº“çš„å¤§å°ã€‚
<img width="855" alt="å›¾ç‰‡" src="https://user-images.githubusercontent.com/51129600/60667705-bfb66800-9e9c-11e9-9181-bed0f2fd86a1.png">

è½¬åˆ° CMake å·¥å…·é“¾çš„è¿‡ç¨‹è¿˜é‡åˆ°ä¸‹é¢å‡ ä¸ªé—®é¢˜ã€‚

**libffmpeg.so æ‰¾ä¸åˆ°**

libffmpeg.so æ˜¯äº‹å…ˆé€šè¿‡ shell å‘½ä»¤ç¼–è¯‘æˆçš„ï¼Œåœ¨ ffmpeg build æ–‡ä»¶å¤¹ä¸­ï¼Œå¹¶ä¸”å‡ ä¹ä¸ä¼šæ”¹å˜ï¼Œé™¤éæ˜¯è¦ä¿®æ”¹ ffmpegã€‚
åœ¨ CMake ä¸­é€šè¿‡ 
```
add_library(ijkffmpeg SHARED IMPORTED)
set_target_properties( # Specifies the target library.
    ijkffmpeg
    PROPERTIES
    IMPORTED_LOCATION ${FFMPAG_SHARED_DIR}/libijkffmpeg.so
)
```
å¼•å…¥é¢„ç¼–è¯‘å¥½çš„ ijkffmpegï¼Œåœ¨ç¼–è¯‘ ijkplayer çš„è¿‡ç¨‹å¯ä»¥é¡ºåˆ©å®Œæˆé“¾æ¥ã€‚ä½†æ˜¯æ‰“åŒ…è¿è¡Œæ‰¾ä¸åˆ° libijkffmpeg.soã€‚åˆ†ææœ€ç»ˆçš„ apk ä»¥åŠ fijkplayer-full.aar ï¼Œå‘ç°å…¶ä¸­éƒ½æ²¡æœ‰ libijkffmpeg.so æ–‡ä»¶ï¼Œæ‰€ä»¥æ˜¯æ‰“åŒ… aar çš„æ—¶å€™æ²¡æœ‰å°†è¿™ä¸ªæ–‡ä»¶æ‰“åŒ…è¿›å»ã€‚æŸ¥çœ‹å·¥ç¨‹ç›®å½•ç»“æ„ï¼Œå‘ç°ç¼–è¯‘å¥½çš„ libijkplayer.so å’Œ libijksdl.so éƒ½åœ¨æ–‡ä»¶å¤¹ `/build/intermediates/cmake/debug/obj/armeabi-v7a` ä¸­ï¼Œæ‰€ä»¥è¿˜éœ€è¦ä¿®æ”¹ CMakeLists.txt åœ¨æ¯æ¬¡ç¼–è¯‘çš„æ—¶å€™å°† libijkffmpeg.so å¤åˆ¶è¿‡å»ã€‚æœ€åçš„è§£å†³æ–¹æ¡ˆæ˜¯
```
add_library(ijkffmpeg SHARED IMPORTED)
set_target_properties( # Specifies the target library.
    ijkffmpeg
    PROPERTIES
    IMPORTED_LOCATION ${FFMPAG_SHARED_DIR}/libijkffmpeg.so
    )

add_custom_target(cpffmpeg
    COMMAND mkdir -p ${CMAKE_LIBRARY_OUTPUT_DIRECTORY}
    COMMAND cp ${FFMPAG_SHARED_DIR}/libijkffmpeg.so ${CMAKE_LIBRARY_OUTPUT_DIRECTORY}
)

add_dependencies(ijkffmpeg cpffmpeg)
```
æ²¡æœ‰æ‰¾åˆ°ä¸€æ¡å‘½ä»¤èƒ½å¤Ÿè§£å†³çš„ï¼Œæ‰€ä»¥éº»çƒ¦äº†ä¸€ç‚¹å¤šå†™äº†ç‚¹ï¼Œç”¨ä¸¤ä¸ªcmake å‘½ä»¤è§£å†³ã€‚

**cpufeatures ç¼–è¯‘å‡ºé”™**

åŸé¡¹ç›®ä¸­ç”¨åˆ°äº† ndk ä¸­çš„ cpufeaturesï¼Œæˆ‘åœ¨ CMake æ–‡ä»¶ä¸­ä¹Ÿå¼•å…¥å¹¶ç¼–è¯‘äº† cpufeaturesï¼Œä½†åœ¨ç¼–è¯‘ x86 ä»¥åŠ x86_64 æ¶æ„çš„æ—¶å€™å´å‡ºç°äº†ç¼–è¯‘é”™è¯¯ï¼Œå…·ä½“æ˜¯ä¸€å¤„æœªè¯†åˆ«çš„æ±‡ç¼–æŒ‡ä»¤ã€‚
æœ€åå‘ç°æ˜¯ ndk r15c ç‰ˆæœ¬ä¸­ æ–‡ä»¶  $ANDROID_NDK/sources/android/cpufeatures/cpu-features.c ä¸­å°‘äº†å‡ ä¸ªæ¢è¡Œç¬¦ï¼Œè¡¥ä¸Šä¹‹åï¼ˆä¸‹é¢å†…å®¹ï¼‰ç¼–è¯‘å°±æ²¡é—®é¢˜äº†ã€‚

```c
static __inline__ void x86_cpuid(int func, int values[4])
{
    int a, b, c, d;
    /* We need to preserve ebx since we're compiling PIC code */
    /* this means we can't use "=b" for the second output register */
    __asm__ __volatile__ ( \
      "push %%ebx"
      "cpuid\n" \
      "mov %%ebx, %1\n"
      "pop %%ebx\n"
      : "=a" (a), "=r" (b), "=c" (c), "=d" (d) \
      : "a" (func) \
    );
    values[0] = a;
    values[1] = b;
    values[2] = c;
    values[3] = d;
}
``` 
æ„å¤–çš„æ˜¯æˆ‘æœ€ç»ˆå‘ç° ijkplayer é¡¹ç›®ä¸­æ²¡æœ‰ç”¨åˆ° cpufeatures çš„åœ°æ–¹ï¼Œå¯èƒ½æ˜¯ gpl åè®®çš„ android-ndk-profiler éƒ¨åˆ†ç”¨äº†å§ï¼Œä½†é¡¹ç›®ä¸­é»˜è®¤ä½¿ç”¨äº†ä¸€ä¸ªå‡çš„ android-ndk-profilerï¼Œæ­¤éƒ¨åˆ†æ²¡æœ‰å»æ·±ç©¶ï¼Œæ€§èƒ½åˆ†æä½¿ç”¨ simpleperf å°±è¶³å¤Ÿäº†ã€‚
æœ€åè¿˜æ˜¯å»æ‰ CMake ä¸­ cpufeatures çš„éƒ¨åˆ†ã€‚

æ­¤éƒ¨åˆ† CMakeLists.txt çš„å®Œæ•´å†…å®¹è¯·çœ‹   
https://github.com/befovy/ijkplayer/blob/master/android/ijkplayer/fijkplayer-full/src/main/CMakeLists.txt   
https://github.com/befovy/ijkplayer/blob/master/ijkmedia/CMakeLists.txt   
https://github.com/befovy/ijkplayer/blob/master/ijkmedia/ijkplayer/CMakeLists.txt   
https://github.com/befovy/ijkplayer/blob/master/ijkmedia/ijksdl/CMakeLists.txt   

<!--mirror-->
## ç»“æŸè¯­

ğŸ˜„ é™„ä¸€å¼  NDK æ–­ç‚¹è°ƒè¯•çš„å¤§å›¾ ğŸ‘

![](https://cdn.jsdelivr.net/gh/befovy/images@master/images/2019/12/05/20191205232707.png)

åˆšå¼€å§‹å†™åšå®¢ï¼Œå¯èƒ½æœ‰äº›å•°å—¦ï¼Œå¤šå¤šåŒ…æ¶µã€‚æˆ–æ˜¯æ²¡æœ‰è¯´æ˜ç™½çš„åœ°æ–¹ï¼Œè¯·å¤§æ–¹çš„å‰å¾€[åŸå§‹åœ°å€](https://github.com/befovy/befovy.github.io/issues/3)è¿›è¡Œè¯„è®ºã€‚

æœ€è¿‘å¯¹ Flutter äº§ç”Ÿäº†å…´è¶£ï¼Œå¹¶æ‰“ç®—ç”¨ ijkplayer å¼€å‘ä¸€ä¸ª Flutter çš„æ’­æ”¾å™¨ Pluginï¼Œ ç¥æˆ‘æ—©æ—¥å®Œæˆã€‚


> æœ¬æ–‡é€šè¿‡ mirror å’Œ hugo ç”Ÿæˆï¼ŒåŸå§‹åœ°å€ https://github.com/befovy/blogback/issues/5

vy/blogback/issues/5

tps://github.com/befovy/blogback/issues/5

